<project default="jar:jar"
         xmlns:ant="jelly:ant"
         xmlns:maven="jelly:maven"
         xmlns:j="jelly:core">

    <postGoal name="java:compile">
        <attainGoal name="generate-hibernate-properties"/>
        <attainGoal name="generate-version-properties"/>
    </postGoal>

    <postGoal name="java:jar-resources">
        <ant:native2ascii encoding="utf8" src="${maven.src.dir}/java"
                          dest="${maven.build.dest}"
                          includes="**/*.properties"/>
    </postGoal>

    <goal name="generate-hibernate-properties">
        <copy tofile="${maven.build.dest}/hibernate.properties"
              file="${basedir}/src/conf/hibernate/hibernate.properties">
            <filterset>
                <filter token="HIBERNATE_DIALECT" value="${hibernate.dialect}"/>
                <filter token="JDBC_DRIVER"
                        value="${hibernate.connection.driver_class}"/>
                <filter token="JDBC_URL" value="${hibernate.connection.url}"/>
                <filter token="JDBC_USERNAME"
                        value="${hibernate.connection.username}"/>
                <filter token="JDBC_PASSWORD"
                        value="${hibernate.connection.password}"/>
            </filterset>
        </copy>
    </goal>

    <goal name="generate-version-properties">
        <exec outputproperty="subversion.revision"
              failonerror="false"
              failifexecutionfails="false"
              executable="${svnversion.path}">
            <arg line="${basedir}"/>
        </exec>
        <echo>subversion revision: ${subversion.revision}</echo>
        <mkdir dir="${maven.build.dest}/META-INF"/>
        <echo file="${maven.build.dest}/META-INF/org.openvpms.version.properties">
            version=${pom.currentVersion}
            revision=${subversion.revision}
        </echo>
    </goal>

    <goal name="dev:install" prereqs="war:webapp">
        <j:set var="mysqljar"
               value="${pom.getDependency('mysql:mysql-connector-java').artifact}"/>
        <ant:copy tofile="${tomcat.webapps.dir}/../shared/lib/${mysqljar}"
                  file="${pom.getDependencyPath('mysql:mysql-connector-java')}"/>
        <ant:copy todir="${tomcat.webapps.dir}/${pom.artifactId}">
            <fileset dir="${maven.war.webapp.dir}"/>
        </ant:copy>
    </goal>

</project>
