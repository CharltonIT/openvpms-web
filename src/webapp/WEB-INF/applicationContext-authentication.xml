<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN"
        "http://www.springframework.org/dtd/spring-beans.dtd">

<beans>
    <!-- ================================================================== -->
    <!--                       USER SERVICE DEFINITIONS                   = -->
    <!-- ================================================================== -->

    <!--  The User DAO bean -->
    <bean id="userDao"
          class="org.openvpms.component.business.dao.hibernate.im.security.UserDAOHibernate">
        <property name="sessionFactory">
            <ref bean="sessionFactory"/>
        </property>
    </bean>

    <!-- The User Details service -->
    <bean id="userService"
          class="org.openvpms.component.business.service.security.UserService">
        <constructor-arg index="0">
            <ref local="userDao"/>
        </constructor-arg>
    </bean>

    <!-- ================================================================== -->
    <!--                            FILTER CHAIN                            -->
    <!-- ================================================================== -->

    <bean id="filterChainProxy"
          class="org.acegisecurity.util.FilterChainProxy">
        <property name="filterInvocationDefinitionSource">
            <value>
                CONVERT_URL_TO_LOWERCASE_BEFORE_COMPARISON
                PATTERN_TYPE_APACHE_ANT
                /**=httpSessionContextIntegrationFilter,authenticationProcessingFilter,anonymousProcessingFilter,securityEnforcementFilter
            </value>
        </property>
    </bean>

    <!-- The first item in the chain -->
    <bean id="httpSessionContextIntegrationFilter"
          class="org.acegisecurity.context.HttpSessionContextIntegrationFilter">
        <property name="context">
            <value>org.acegisecurity.context.SecurityContextImpl</value>
        </property>
    </bean>

    <!-- the second item in the chain-->
    <bean id="authenticationProcessingFilter"
          class="org.acegisecurity.ui.webapp.AuthenticationProcessingFilter">
        <property name="authenticationManager">
            <ref bean="authenticationManager"/>
        </property>
        <property name="authenticationFailureUrl">
            <value>/login</value>
        </property>
        <property name="defaultTargetUrl">
            <value>/app</value>
        </property>
        <property name="alwaysUseDefaultTargetUrl">
            <value>true</value>
        </property>
        <property name="filterProcessesUrl">
            <value>/j_acegi_security_check</value>
        </property>
    </bean>

    <!-- the third item in the chain -->
    <bean id="anonymousProcessingFilter"
          class="org.acegisecurity.providers.anonymous.AnonymousProcessingFilter">
        <property name="key">
            <value>foobar</value>
        </property>
        <property name="userAttribute">
            <value>anonymousUser,ROLE_ANONYMOUS</value>
        </property>
    </bean>

    <!-- the fourth item in the chain -->
    <bean id="securityEnforcementFilter"
          class="org.acegisecurity.intercept.web.SecurityEnforcementFilter">
        <property name="filterSecurityInterceptor">
            <ref local="filterInvocationInterceptor"/>
        </property>
        <property name="authenticationEntryPoint">
            <ref local="authenticationProcessingFilterEntryPoint"/>
        </property>
    </bean>

    <bean id="filterInvocationInterceptor"
          class="org.acegisecurity.intercept.web.FilterSecurityInterceptor">
        <property name="authenticationManager">
            <ref bean="authenticationManager"/>
        </property>
        <property name="accessDecisionManager">
            <ref local="httpRequestAccessDecisionManager"/>
        </property>
        <property name="objectDefinitionSource">
            <value>
                CONVERT_URL_TO_LOWERCASE_BEFORE_COMPARISON
                PATTERN_TYPE_APACHE_ANT
                /login*=IS_AUTHENTICATED_FULLY,IS_AUTHENTICATED_ANONYMOUSLY
                /**=IS_AUTHENTICATED_FULLY
            </value>
        </property>
    </bean>

    <bean id="httpRequestAccessDecisionManager"
          class="org.acegisecurity.vote.AffirmativeBased">
        <property name="allowIfAllAbstainDecisions">
            <value>false</value>
        </property>
        <property name="decisionVoters">
            <list>
                <ref bean="authenticatedVoter"/>
            </list>
        </property>
    </bean>

    <bean id="authenticatedVoter"
          class="org.acegisecurity.vote.AuthenticatedVoter">
        <property name="authenticationTrustResolver">
            <ref local="authenticationTrustResolver"/>
        </property>
    </bean>

    <bean id="authenticationTrustResolver"
          class="org.acegisecurity.AuthenticationTrustResolverImpl"/>

    <bean id="authenticationProcessingFilterEntryPoint"
          class="org.openvpms.web.servlet.EchoAuthenticationEntryPoint">
        <property name="loginFormUrl">
            <value>/login</value>
        </property>
        <property name="forceHttps">
            <value>false</value>
        </property>
    </bean>

    <!-- ================================================================== -->
    <!--                            AUTHENTICATION                          -->
    <!-- ================================================================== -->

    <bean id="authenticationManager"
          class="org.acegisecurity.providers.ProviderManager">
        <property name="providers">
            <list>
                <ref bean="daoAuthenticationProvider"/>
                <ref local="anonymousAuthenticationProvider"/>
            </list>
        </property>
    </bean>

    <bean id="daoAuthenticationProvider"
          class='org.acegisecurity.providers.dao.DaoAuthenticationProvider'>
        <property name="userDetailsService">
            <ref bean="userService"/>
        </property>
    </bean>

    <bean id="anonymousAuthenticationProvider"
          class="org.acegisecurity.providers.anonymous.AnonymousAuthenticationProvider">
        <property name="key">
            <value>foobar</value>
        </property>
    </bean>

    <!-- This bean automatically receives AuthenticationEvent messages from
   daoAuthenticationProvider -->
    <bean id="loggerListener"
          class="org.acegisecurity.event.authentication.LoggerListener"/>

</beans>

